# -*- coding: utf-8 -*-
"""
Created on Tue Aug 05 16:16:38 2014

@author: tallen
"""

def seyhan_stewart_getcoefs(T):
    from openquake.hazardlib.gsim.base import CoeffsTable
    from openquake.hazardlib import imt
    ''' 
    # coeficients from Boore etal (2014) NGA-West2 GMPE
    # fmt = T, c, Vc, Vref, f1, f3, f4, f5
    
    for PGA, T = 0.0
    for PGV, T = -1.0
    
    Seyhan, E., and J. P. Stewart (2014). Semi-empirical nonlinear site 
    amplification from NGA-West 2 data and simulations, Earthq. Spectra, 
    http://dx.doi.org/10.1193/063013EQS181M.
    '''

    COEFFS = CoeffsTable(sa_damping=5, table="""\
            imt c    vc    vref    f1    f3    f4    f5            
            pgv   	-8.40E-01	1300	760	0	0.1	-1.00E-01	-8.44E-03  
            pga   	-6.00E-01	1500	760	0	0.1	-1.50E-01	-7.01E-03  
            0.01 	-6.04E-01	1500.2	760	0	0.1	-1.48E-01	-7.01E-03
            0.02 	-5.74E-01	1500.36	760	0	0.1	-1.47E-01	-7.28E-03
            0.022	-5.67E-01	1500.68	760	0	0.1	-1.48E-01	-7.32E-03
            0.025	-5.55E-01	1501.04	760	0	0.1	-1.50E-01	-7.36E-03
            0.029	-5.39E-01	1501.26	760	0	0.1	-1.53E-01	-7.37E-03
            0.03 	-5.34E-01	1502.95	760	0	0.1	-1.55E-01	-7.35E-03
            0.032	-5.25E-01	1503.12	760	0	0.1	-1.57E-01	-7.31E-03
            0.035	-5.12E-01	1503.24	760	0	0.1	-1.61E-01	-7.21E-03
            0.036	-5.08E-01	1503.32	760	0	0.1	-1.64E-01	-7.17E-03
            0.04 	-4.91E-01	1503.35	760	0	0.1	-1.68E-01	-6.98E-03
            0.042	-4.83E-01	1503.34	760	0	0.1	-1.72E-01	-6.87E-03
            0.044	-4.76E-01	1503.13	760	0	0.1	-1.76E-01	-6.77E-03
            0.045	-4.72E-01	1502.84	760	0	0.1	-1.81E-01	-6.72E-03
            0.046	-4.69E-01	1502.47	760	0	0.1	-1.86E-01	-6.67E-03
            0.048	-4.63E-01	1502.01	760	0	0.1	-1.92E-01	-6.56E-03
            0.05 	-4.58E-01	1501.42	760	0	0.1	-1.96E-01	-6.47E-03
            0.055	-4.48E-01	1500.71	760	0	0.1	-2.01E-01	-6.25E-03
            0.06 	-4.42E-01	1499.83	760	0	0.1	-2.07E-01	-6.07E-03
            0.065	-4.40E-01	1498.74	760	0	0.1	-2.12E-01	-5.93E-03
            0.067	-4.40E-01	1497.42	760	0	0.1	-2.18E-01	-5.88E-03
            0.07 	-4.40E-01	1495.85	760	0	0.1	-2.23E-01	-5.82E-03
            0.075	-4.44E-01	1494	760	0	0.1	-2.29E-01	-5.73E-03  
            0.08 	-4.50E-01	1491.82	760	0	0.1	-2.34E-01	-5.67E-03
            0.085	-4.58E-01	1489.29	760	0	0.1	-2.38E-01	-5.63E-03
            0.09 	-4.67E-01	1486.36	760	0	0.1	-2.42E-01	-5.61E-03
            0.095	-4.77E-01	1482.98	760	0	0.1	-2.46E-01	-5.60E-03
            0.1  	-4.87E-01	1479.12	760	0	0.1	-2.49E-01	-5.60E-03
            0.11 	-5.06E-01	1474.74	760	0	0.1	-2.52E-01	-5.62E-03
            0.12 	-5.24E-01	1469.75	760	0	0.1	-2.54E-01	-5.67E-03
            0.13 	-5.42E-01	1464.09	760	0	0.1	-2.56E-01	-5.72E-03
            0.133	-5.48E-01	1457.76	760	0	0.1	-2.57E-01	-5.74E-03
            0.14 	-5.60E-01	1450.71	760	0	0.1	-2.57E-01	-5.78E-03
            0.15 	-5.80E-01	1442.85	760	0	0.1	-2.57E-01	-5.85E-03
            0.16 	-6.01E-01	1434.22	760	0	0.1	-2.56E-01	-5.91E-03
            0.17 	-6.23E-01	1424.85	760	0	0.1	-2.54E-01	-5.97E-03
            0.18 	-6.45E-01	1414.77	760	0	0.1	-2.52E-01	-6.02E-03
            0.19 	-6.67E-01	1403.99	760	0	0.1	-2.50E-01	-6.08E-03
            0.2  	-6.88E-01	1392.61	760	0	0.1	-2.47E-01	-6.14E-03
            0.22 	-7.24E-01	1380.72	760	0	0.1	-2.43E-01	-6.26E-03
            0.24 	-7.57E-01	1368.51	760	0	0.1	-2.40E-01	-6.38E-03
            0.25 	-7.72E-01	1356.21	760	0	0.1	-2.36E-01	-6.44E-03
            0.26 	-7.87E-01	1343.89	760	0	0.1	-2.32E-01	-6.50E-03
            0.28 	-8.16E-01	1331.67	760	0	0.1	-2.27E-01	-6.60E-03
            0.29 	-8.30E-01	1319.83	760	0	0.1	-2.23E-01	-6.65E-03
            0.3  	-8.42E-01	1308.47	760	0	0.1	-2.19E-01	-6.70E-03
            0.32 	-8.62E-01	1297.65	760	0	0.1	-2.15E-01	-6.80E-03
            0.34 	-8.77E-01	1287.5	760	0	0.1	-2.11E-01	-6.89E-03
            0.35 	-8.84E-01	1278.06	760	0	0.1	-2.07E-01	-6.93E-03
            0.36 	-8.90E-01	1269.19	760	0	0.1	-2.03E-01	-6.97E-03
            0.38 	-9.00E-01	1260.74	760	0	0.1	-2.00E-01	-7.05E-03
            0.4  	-9.11E-01	1252.66	760	0	0.1	-1.96E-01	-7.13E-03
            0.42 	-9.22E-01	1244.8	760	0	0.1	-1.92E-01	-7.19E-03
            0.44 	-9.35E-01	1237.03	760	0	0.1	-1.88E-01	-7.26E-03
            0.45 	-9.41E-01	1229.23	760	0	0.1	-1.84E-01	-7.29E-03
            0.46 	-9.47E-01	1221.16	760	0	0.1	-1.79E-01	-7.32E-03
            0.48 	-9.59E-01	1212.74	760	0	0.1	-1.75E-01	-7.38E-03
            0.5  	-9.69E-01	1203.91	760	0	0.1	-1.70E-01	-7.44E-03
            0.55 	-9.89E-01	1194.59	760	0	0.1	-1.66E-01	-7.58E-03
            0.6  	-1.00E+00	1184.93	760	0	0.1	-1.61E-01	-7.73E-03
            0.65 	-1.01E+00	1175.19	760	0	0.1	-1.56E-01	-7.87E-03
            0.667	-1.01E+00	1165.69	760	0	0.1	-1.50E-01	-7.92E-03
            0.7  	-1.01E+00	1156.46	760	0	0.1	-1.45E-01	-8.00E-03
            0.75 	-1.02E+00	1147.59	760	0	0.1	-1.39E-01	-8.12E-03
            0.8  	-1.02E+00	1139.21	760	0	0.1	-1.33E-01	-8.22E-03
            0.85 	-1.03E+00	1131.34	760	0	0.1	-1.26E-01	-8.30E-03
            0.9  	-1.04E+00	1123.91	760	0	0.1	-1.20E-01	-8.36E-03
            0.95 	-1.04E+00	1116.83	760	0	0.1	-1.13E-01	-8.41E-03
            1.    	-1.05E+00	1109.95	760	0	0.1	-1.05E-01	-8.44E-03
            1.1  	-1.06E+00	1103.07	760	0	0.1	-9.77E-02	-8.47E-03
            1.2  	-1.06E+00	1096.04	760	0	0.1	-9.02E-02	-8.42E-03
            1.3  	-1.06E+00	1088.67	760	0	0.1	-8.27E-02	-8.29E-03
            1.4  	-1.05E+00	1080.77	760	0	0.1	-7.53E-02	-8.06E-03
            1.5  	-1.05E+00	1072.39	760	0	0.1	-6.79E-02	-7.71E-03
            1.6  	-1.04E+00	1061.77	760	0	0.1	-6.04E-02	-7.23E-03
            1.7  	-1.04E+00	1049.29	760	0	0.1	-5.34E-02	-6.66E-03
            1.8  	-1.04E+00	1036.42	760	0	0.1	-4.71E-02	-6.03E-03
            1.9  	-1.04E+00	1023.14	760	0	0.1	-4.14E-02	-5.40E-03
            2.    	-1.04E+00	1009.49	760	0	0.1	-3.61E-02	-4.79E-03
            2.2  	-1.04E+00	995.52	760	0	0.1	-3.14E-02	-3.78E-03
            2.4  	-1.03E+00	981.33	760	0	0.1	-2.71E-02	-3.02E-03
            2.5  	-1.03E+00	966.94	760	0	0.1	-2.31E-02	-2.72E-03
            2.6  	-1.03E+00	952.34	760	0	0.1	-1.96E-02	-2.46E-03
            2.8  	-1.02E+00	937.52	760	0	0.1	-1.65E-02	-2.08E-03
            3.    	-1.01E+00	922.43	760	0	0.1	-1.36E-02	-1.83E-03
            3.2  	-1.00E+00	908.79	760	0	0.1	-1.12E-02	-1.67E-03
            3.4  	-9.95E-01	896.15	760	0	0.1	-9.27E-03	-1.58E-03
            3.5  	-9.91E-01	883.16	760	0	0.1	-7.46E-03	-1.55E-03
            3.6  	-9.87E-01	870.05	760	0	0.1	-5.79E-03	-1.54E-03
            3.8  	-9.78E-01	857.07	760	0	0.1	-4.39E-03	-1.52E-03
            4.    	-9.69E-01	844.48	760	0	0.1	-3.21E-03	-1.52E-03
            4.2  	-9.60E-01	832.45	760	0	0.1	-2.29E-03	-1.52E-03
            4.4  	-9.51E-01	821.18	760	0	0.1	-1.61E-03	-1.50E-03
            4.6  	-9.41E-01	810.79	760	0	0.1	-1.04E-03	-1.48E-03
            4.8  	-9.30E-01	801.41	760	0	0.1	-5.55E-04	-1.46E-03
            5.    	-9.20E-01	793.13	760	0	0.1	-2.55E-04	-1.44E-03
            5.5  	-8.92E-01	785.73	760	0	0.1	-1.00E-04	-1.40E-03
            6.    	-8.63E-01	779.91	760	0	0.1	-4.55E-05	-1.38E-03
            6.5  	-8.34E-01	775.6	760	0	0.1	-3.64E-05	-1.37E-03  
            7.    	-8.05E-01	772.68	760	0	0.1	-4.55E-05	-1.37E-03
            7.5  	-7.77E-01	771.01	760	0	0.1	-5.46E-05	-1.37E-03
            8.    	-7.50E-01	760.81	760	0	0.1	1.00E-04	-1.37E-03
            8.5  	-7.25E-01	764.5	760	0	0.1	1.00E-04	-1.37E-03  
            9.    	-7.02E-01	768.07	760	0	0.1	1.00E-04	-1.37E-03
            9.5  	-6.79E-01	771.55	760	0	0.1	1.00E-04	-1.36E-03
            10.   	-6.56E-01	775	760	0	0.1	0.00E+00	-1.36E-03    
            """)
            
    
    if T == 0.0:
        ct = COEFFS[imt.PGA()]
    elif T == -1.0:
        ct = COEFFS[imt.PGV()]
    else:
        ct = COEFFS[imt.SA(damping=5, period=T)]

    return ct

# returns amp factor for given input Vs30, period and PGA    
def seyhan_stewart_siteamp(vs30, T, pgar):
    '''
    Reference PGA (pgar) is in g
    
    factor returned is in non-log units
    
    '''
    from numpy import exp, log
    
    # get coefs for period T
    coeffs = seyhan_stewart_getcoefs(T)
    
    # first get linear
    if vs30 <= float(coeffs['vc']):
        lnFlin = coeffs['c'] * log(vs30 / float(coeffs['vref']))
    else:
        lnFlin = coeffs['c'] * log(coeffs['vc'] / float(coeffs['vref']))
        
    # get non-linear
    f2 = coeffs['f4'] * (exp(coeffs['f5'] *(min([vs30, 760.]) - 360.)) \
         - exp(coeffs['f5'] * (760. - 360.)))
    
    lnFnl = coeffs['f1'] + f2 * log((pgar + coeffs['f3']) / coeffs['f3'])
    
    # return total site response factor
    return exp(lnFlin + lnFnl)

